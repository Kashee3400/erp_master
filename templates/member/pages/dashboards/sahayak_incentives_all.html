{% extends 'member/pages/base.html' %}
{% load i18n static crispy_forms_tags member_filters import_export_tags %}

{% block title %}
{% trans 'Sahayak Incentives' %}
{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" type="text/css" href="{% static 'import_export/import.css' %}" />
<style>
  .error-alert {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
{% endblock %}

{% block extrahead %}
<script src="{% static 'import_export/guess_format.js' %}"></script>
{% if confirm_form %}
{{ confirm_form.media }}
{% else %}
{{ import_form.media }}
{% endif %}
{% endblock %}

{% block content %}
<!-- Error/Success Messages -->
{% if messages %}
<div class="row mb-3">
  <div class="col-12">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show error-alert" role="alert">
      <strong>
        {% if message.tags == 'error' %}
        <i class="fas fa-exclamation-circle"></i> {% trans 'Error!' %}
        {% elif message.tags == 'success' %}
        <i class="fas fa-check-circle"></i> {% trans 'Success!' %}
        {% elif message.tags == 'warning' %}
        <i class="fas fa-exclamation-triangle"></i> {% trans 'Warning!' %}
        {% elif message.tags == 'info' %}
        <i class="fas fa-info-circle"></i> {% trans 'Info' %}
        {% endif %}
      </strong>
      {{ message }}
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
          aria-hidden="true">&times;</span></button>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Filters Section -->
<div class="row">
  <div class="col-12 bg-white px-3 py-2">
    <form method="GET" class="row g-2" id="filterForm">
      {% for field in filter.form %}
      <div class="col-lg-3 col-md-4 col-sm-6">
        <label class="form-label">{{ field.label }}</label>
        {{ field }}
        {% if field.errors %}
        <div class="invalid-feedback d-block">
          {% for error in field.errors %}
          <small class="text-danger">{{ error }}</small>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
      <div class="col-12 d-flex gap-2">
        <button type="submit" class="btn btn-sm btn-primary"><i class="fas fa-filter"></i> {% trans 'Filter' %}</button>
        <a href="{% url 'sahayak_incentives_list' %}" class="btn btn-sm btn-secondary"><i class="fas fa-undo"></i> 
          {% trans 'Reset' %}</a>
      </div>
    </form>
  </div>
</div>

<!-- Main Content Section -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card p-3">
      <div class="card-header">
        <div class="row">
          <!-- Left Section: Title & Description -->
          <div class="col-lg-3 col-md-12 mb-3">
            <h5 class="mb-0">{% trans 'Sahayak Incentives' %}</h5>
            <p class="text-sm mb-0">
              {% trans 'Sahayak incentive data' %}
            </p>
          </div>
          <!-- Right Section: Buttons -->
          <div class="col-lg-9 col-md-12">
            <div class="row g-3 align-items-end">
              <div class="col-12 d-flex justify-content-end gap-2">
                <a href="{% url 'sahayak_incentives_create' %}" class="btn btn-success btn-sm"><i
                    class="fas fa-plus"></i> {% trans 'Add' %}</a>
                <button type="button" class="btn btn-dark btn-sm" data-toggle="modal" data-target="#importModal"><i
                    class="fas fa-file-excel"></i> {% trans 'Import' %}</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-body">
        {% if objects %}
        <div class="table-responsive">
          <div class="dataTable-wrapper dataTable-loading no-footer sortable searchable fixed-height fixed-columns">
            <form id="selectedForm" method="POST" action="{% url 'sahayak_incentives_list' %}"
              onsubmit="return validateBulkAction()">
              {% csrf_token %}
              <div class="row mb-3">
                <div class="col-md-6 col-12 mb-2 mb-md-0">
                  <div class="input-group">
                    <select id="action-dropdown" name="action" class="form-control">
                      <option value="">
                        {% trans 'Choose Action' %}
                      </option>
                      {% for action in actions %}
                      <option value="{{ action.value }}">{{ action.label }}</option>
                      {% endfor %}
                    </select>
                    <div class="input-group-append">
                      <button type="submit" class="btn btn-secondary">{% trans 'Go' %}</button>
                    </div>
                  </div>
                  <small id="action-error" class="text-danger d-none">{% trans 'Please select an action and at least one
                    row.' %}</small>
                </div>
                <div class="col-md-6 col-12 text-md-end">
                  <span class="badge bg-info p-2">{% trans 'Total Rows' %}: {{ total_rows }}</span>
                  <span class="badge bg-primary p-2">{% trans 'Selected' %}: <span id="selected-count">0</span></span>
                </div>
              </div>

              <table class="table table-striped table-hover" style="width:100%">
                <thead class="thead-dark">
                  <tr>
                    <th style="width: 50px;">
                      <input type="checkbox" id="selectAll" title="{% trans 'Select All' %}" />
                    </th>
                    <th>{% trans 'ID' %}</th>
                    <th>{% trans 'MCC' %}</th>
                    <th>{% trans 'MCC Code' %}</th>
                    <th>{% trans 'MPP' %}</th>
                    <th>{% trans 'MPP Code' %}</th>
                    <th>{% trans 'Sahayak Name' %}</th>
                    <th>{% trans 'Month' %}</th>
                    <th>{% trans 'Opening' %}</th>
                    <th>{% trans 'Milk Incentive' %}</th>
                    <th>{% trans 'Other Incentive' %}</th>
                    <th>{% trans 'Payable' %}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for object in objects %}
                  <tr>
                    <td>
                      <input type="checkbox" class="selectRows" name="selected_rows" value="{{ object.id }}" />
                    </td>
                    <td>{{ object.id }}</td>
                    <td>
                      <a href="{% url 'sahayak_incentives_update' object.id %}" class="text-primary">
                        {{ object.mcc_name|default:"-" }}
                      </a>
                    </td>
                    <td>{{ object.mcc_code|default:"-" }}</td>
                    <td>{{ object.mpp_name|default:"-" }}</td>
                    <td>{{ object.mpp_code|default:"-" }}</td>
                    <td>{{ object.user.get_full_name|default:object.user.username }}</td>
                    <td>{{ object.month|date:"M Y"|default:"-" }}</td>
                    <td>{{ object.opening|floatformat:2|default:"0.00" }}</td>
                    <td>{{ object.milk_incentive|floatformat:2|default:"0.00" }}</td>
                    <td>{{ object.other_incentive|floatformat:2|default:"0.00" }}</td>
                    <td><strong>{{ object.payable|floatformat:2|default:"0.00" }}</strong></td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="12" class="text-center py-4">
                      <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                      <p class="text-muted">{% trans 'No incentives found matching your criteria.' %}</p>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </form>
          </div>
        </div>

        <!-- Pagination -->
        {% if objects.has_other_pages %}
        <div class="d-flex justify-content-between align-items-center mt-4">
          <nav aria-label="Page navigation">
            <ul class="pagination mb-0">
              {% if objects.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}"
                  title="{% trans 'First Page' %}">
                  <i class="fas fa-angle-double-left"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link"
                  href="?page={{ objects.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}"
                  title="{% trans 'Previous Page' %}">
                  <i class="fas fa-angle-left"></i>
                </a>
              </li>
              {% endif %}

              <li class="page-item disabled">
                <span class="page-link">
                  {% blocktrans with page=objects.number total=objects.paginator.num_pages %}
                  Page {{ page }} of {{ total }}
                  {% endblocktrans %}
                </span>
              </li>

              {% if objects.has_next %}
              <li class="page-item">
                <a class="page-link"
                  href="?page={{ objects.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}"
                  title="{% trans 'Next Page' %}">
                  <i class="fas fa-angle-right"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link"
                  href="?page={{ objects.paginator.num_pages }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}"
                  title="{% trans 'Last Page' %}">
                  <i class="fas fa-angle-double-right"></i>
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>
          <span class="badge bg-secondary p-2">{% trans 'Total' %}: {{ total_rows }} {% trans 'rows' %}</span>
        </div>
        {% endif %}
        {% else %}
        <div class="text-center py-5">
          <i class="fas fa-database fa-4x text-muted mb-3"></i>
          <h5 class="text-muted">{% trans 'No Data Available' %}</h5>
          <p class="text-muted">{% trans 'Start by adding new incentives or importing data.' %}</p>
          <div class="mt-3">
            <a href="{% url 'sahayak_incentives_create' %}" class="btn btn-success"><i class="fas fa-plus"></i> {% trans
              'Add New' %}</a>
            <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#importModal"><i
                class="fas fa-file-excel"></i> {% trans 'Import Data' %}</button>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-labelledby="importModalTitle"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="importModalTitle">
          <i class="fas fa-file-import"></i> {% trans 'Import Excel To Populate Data' %}
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close"><span
            aria-hidden="true">&times;</span></button>
      </div>
      <form method="post" enctype="multipart/form-data" id="importForm" onsubmit="return validateImportForm()">
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="excel_import" value="excel_import" />

          {% if result %}
          <!-- Display import results/errors -->
          <div
            class="alert alert-{% if result.has_errors or result.has_validation_errors %}danger{% else %}success{% endif %}"
            role="alert">
            {% if result.has_errors or result.has_validation_errors %}
            <h6><i class="fas fa-exclamation-triangle"></i> {% trans 'Import Errors' %}</h6>
            <ul class="mb-0">
              {% for error in result.base_errors %}
              <li>{{ error.error }}</li>
              {% endfor %}
              {% for line, errors in result.row_errors %}
              {% for error in errors %}
              <li>{% trans 'Row' %} {{ line }}: {{ error.error }}</li>
              {% endfor %}
              {% endfor %}
            </ul>
            {% else %}
            <i class="fas fa-check-circle"></i> {% trans 'Import preview successful! Review and confirm to import.' %}
            {% endif %}
          </div>
          {% endif %}

          {% include 'admin/import_export/resource_fields_list.html' with import_or_export='import' %}

          <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle"></i>
            <strong>{% trans 'Instructions:' %}</strong>
            <ul class="mb-0 mt-2">
              <li>{% trans 'Select the file format that matches your file' %}</li>
              <li>{% trans 'Choose your Excel or CSV file' %}</li>
              <li>{% trans 'Ensure your file has the correct column headers' %}</li>
              <li>{% trans 'Click Submit to preview the import' %}</li>
            </ul>
          </div>

          {{ import_form|crispy }}

          {% if import_form.errors %}
          <div class="alert alert-danger mt-3" role="alert">
            <h6><i class="fas fa-exclamation-circle"></i> {% trans 'Form Errors' %}</h6>
            <ul class="mb-0">
              {% for field, errors in import_form.errors.items %}
              {% for error in errors %}
              <li><strong>{{ field }}:</strong> {{ error }}</li>
              {% endfor %}
              {% endfor %}
            </ul>
          </div>
          {% endif %}

          <small id="import-error" class="text-danger d-none"></small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i> {% trans 'Close' %}
          </button>
          <button type="submit" class="btn btn-primary" id="submitImport">
            <i class="fas fa-upload"></i> {% trans 'Submit' %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const selectAllCheckbox = document.getElementById('selectAll')
    const rowCheckboxes = document.querySelectorAll('.selectRows')
    const selectedCountDisplay = document.getElementById('selected-count')
    const actionDropdown = document.getElementById('action-dropdown')
    const actionError = document.getElementById('action-error')

    // Select All functionality
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function () {
        rowCheckboxes.forEach((checkbox) => {
          checkbox.checked = selectAllCheckbox.checked
        })
        updateSelectedCount()
      })
    }

    // Individual checkbox change
    rowCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', function () {
        updateSelectedCount()
        // Update select all checkbox state
        if (selectAllCheckbox) {
          const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked)
          const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked)
          selectAllCheckbox.checked = allChecked
          selectAllCheckbox.indeterminate = someChecked && !allChecked
        }
      })
    })

    function updateSelectedCount() {
      const selectedCount = Array.from(rowCheckboxes).filter((checkbox) => checkbox.checked).length
      selectedCountDisplay.textContent = selectedCount

      // Hide error message if rows are selected
      if (selectedCount > 0 && actionError) {
        actionError.classList.add('d-none')
      }
    }

    // Auto-dismiss alerts after 5 seconds
    const alerts = document.querySelectorAll('.alert-dismissible')
    alerts.forEach(alert => {
      setTimeout(() => {
        const closeButton = alert.querySelector('.close')
        if (closeButton) {
          closeButton.click()
        }
      }, 5000)
    })
  })

  // Validate bulk action form
  function validateBulkAction() {
    const action = document.getElementById('action-dropdown').value
    const selectedRows = document.querySelectorAll('.selectRows:checked')
    const actionError = document.getElementById('action-error')

    if (!action) {
      actionError.textContent = '{% trans "Please select an action." %}'
      actionError.classList.remove('d-none')
      return false
    }

    if (selectedRows.length === 0) {
      actionError.textContent = '{% trans "Please select at least one row." %}'
      actionError.classList.remove('d-none')
      return false
    }

    // Confirm delete action
    if (action === 'bulk_delete') {
      return confirm('{% trans "Are you sure you want to delete the selected items?" %}')
    }

    return true
  }

  // Validate import form
  function validateImportForm() {
    const fileInput = document.querySelector('input[type="file"]')
    const formatSelect = document.querySelector('select[name="format"]')
    const importError = document.getElementById('import-error')

    if (!formatSelect || !formatSelect.value) {
      importError.textContent = '{% trans "Please select a file format." %}'
      importError.classList.remove('d-none')
      return false
    }

    if (!fileInput || !fileInput.files.length) {
      importError.textContent = '{% trans "Please select a file to import." %}'
      importError.classList.remove('d-none')
      return false
    }

    // Show loading state
    const submitButton = document.getElementById('submitImport')
    if (submitButton) {
      submitButton.disabled = true
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Processing..." %}'
    }

    return true
  }
</script>
{% endblock %}